generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER & AUTHENTICATION
// ==========================================

model User {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  phone             String?           @unique
  email             String?
  gender            Gender?
  fullName          String            @map("full_name")
  avatarUrl         String?           @map("avatar_url")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @default(now()) @updatedAt @map("updated_at")
  description       String?
  // Relations
  completedBookings Booking[]         @relation("BookingCompleter")
  assignedTasks     Booking[]         @relation("StaffBookings")
  bookings          Booking[]
  invitedMembers    SalonMembership[] @relation("MembershipInviter")
  salonMemberships  SalonMembership[]
  approvedSalons    Salon[]           @relation("SalonApprover")
  createdSalons     Salon[]           @relation("SalonCreator")
  roles             UserRole[]
  subscriptions     Subscription[] // Added: B2C Subscriptions
  Favorite          Favorite[]

  @@map("user_profiles")
}

model UserRole {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @map("user_id") @db.ObjectId
  role      AppRole
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@map("user_roles")
}

model OtpSession {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  phone        String
  otpHash      String   @map("otp_hash")
  sessionToken String   @unique @map("session_token")
  attempts     Int      @default(0)
  used         Boolean  @default(false)
  ipAddress    String?  @map("ip_address")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("otp_sessions")
}

model RateLimit {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier  String
  action      String
  count       Int      @default(1)
  windowStart DateTime @default(now()) @map("window_start")

  @@unique([identifier, action])
  @@map("rate_limits")
}

// ==========================================
// SALON MANAGEMENT
// ==========================================

model Salon {
  id                  String      @id @default(auto()) @map("_id") @db.ObjectId
  name                String
  slug                String      @unique
  description         String?
  address             String
  city                String
  phone               String?
  email               String?
  websiteURL          String?
  facebookPage        String?
  instagramPage       String?
  whatsAppNumber      String?
  tiktokPage          String?
  imageUrl            String?     @map("image_url")
  operatingHours      Json        @default("{}") @map("operating_hours")
  defaultSlotCapacity Int         @default(4) @map("default_slot_capacity")
  status              SalonStatus @default(pending)
  createdBy           String      @map("created_by") @db.ObjectId
  approvedBy          String?     @map("approved_by") @db.ObjectId
  approvedAt          DateTime?   @map("approved_at")
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @default(now()) @updatedAt @map("updated_at")
  contractAmount      Float?      @map("contract_amount") // Set by Super Admin
  nextDueDate         DateTime?   @map("next_due_date") // Tracked for Frontend

  payments      SalonPayment[]
  // Relations
  bookings      Booking[]
  memberships   SalonMembership[]
  approver      User?             @relation("SalonApprover", fields: [approvedBy], references: [id])
  creator       User              @relation("SalonCreator", fields: [createdBy], references: [id])
  services      Service[]
  slots         Slot[]
  subscriptions Subscription[] // Added: B2B Subscriptions
  Favorite      Favorite[]

  @@map("salons")
}

model SalonPayment {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  salonId String @map("salon_id") @db.ObjectId
  salon   Salon  @relation(fields: [salonId], references: [id], onDelete: Cascade)

  amountPaid    Float  @map("amount_paid")
  monthsPaid    Int    @default(1) @map("months_paid")
  screenshotUrl String @map("screenshot_url")

  // Fixed: Standard String-based Enum mapping for MongoDB
  status PaymentStatus @default(pending)

  paymentDate DateTime @default(now()) @map("payment_date")
  verifiedBy  String?  @map("verified_by") @db.ObjectId
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("salon_payments")
}

model SalonMembership {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  userId    String    @map("user_id") @db.ObjectId
  salonId   String    @map("salon_id") @db.ObjectId
  role      SalonRole
  invitedBy String?   @map("invited_by") @db.ObjectId
  createdAt DateTime  @default(now()) @map("created_at")

  inviter User? @relation("MembershipInviter", fields: [invitedBy], references: [id])
  salon   Salon @relation(fields: [salonId], references: [id], onDelete: Cascade)
  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, salonId])
  @@map("salon_memberships")
}

// ==========================================
// SUBSCRIPTION SYSTEM
// ==========================================

model Subscription {
  id     String             @id @default(auto()) @map("_id") @db.ObjectId
  type   SubscriptionType
  status SubscriptionStatus @default(active)

  // Polymorphic-like association
  salonId String? @map("salon_id") @db.ObjectId
  salon   Salon?  @relation(fields: [salonId], references: [id])

  userId String? @map("user_id") @db.ObjectId
  user   User?   @relation(fields: [userId], references: [id])

  // Payment Integration Fields
  externalId String?   @unique @map("external_subscription_id")
  startDate  DateTime  @default(now()) @map("start_date")
  endDate    DateTime? @map("end_date")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("subscriptions")
}

// ==========================================
// BOOKING & SERVICES
// ==========================================

model Service {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  salonId         String   @map("salon_id") @db.ObjectId
  name            String
  description     String?
  price           Float    @default(0)
  durationMinutes Int      @default(30) @map("duration_minutes")
  showPrice       Boolean  @default(true) @map("show_price")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  bookings Booking[]
  salon    Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@map("services")
}

model Slot {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  salonId     String    @map("salon_id") @db.ObjectId
  date        DateTime
  startTime   DateTime  @map("start_time")
  endTime     DateTime  @map("end_time")
  capacity    Int       @default(3)
  bookedCount Int       @default(0) @map("booked_count")
  createdAt   DateTime  @default(now()) @map("created_at")
  staffId     String?   @map("staff_id") @db.ObjectId
  bookings    Booking[]
  salon       Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@unique([salonId, date, startTime])
  @@map("slots")
}

model Booking {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  userId    String  @map("user_id") @db.ObjectId
  salonId   String  @map("salon_id") @db.ObjectId
  serviceId String  @map("service_id") @db.ObjectId
  slotId    String  @map("slot_id") @db.ObjectId
  staffId   String? @map("staff_id") @db.ObjectId

  bookingDate    DateTime      @map("booking_date")
  startTime      DateTime      @map("start_time")
  endTime        DateTime      @map("end_time")
  status         BookingStatus @default(booked)
  qrCode         String?       @unique @map("qr_code")
  notes          String?
  cancelledAt    DateTime?     @map("cancelled_at")
  serviceStarted DateTime?     @map("service_started")
  completedAt    DateTime?     @map("completed_at")
  completedBy    String?       @map("completed_by") @db.ObjectId
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @default(now()) @updatedAt @map("updated_at")

  staff     User?   @relation("StaffBookings", fields: [staffId], references: [id])
  completer User?   @relation("BookingCompleter", fields: [completedBy], references: [id])
  salon     Salon   @relation(fields: [salonId], references: [id])
  service   Service @relation(fields: [serviceId], references: [id])
  slot      Slot    @relation(fields: [slotId], references: [id])
  user      User    @relation(fields: [userId], references: [id])

  @@map("bookings")
}

model Favorite {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @db.ObjectId
  salon     Salon    @relation(fields: [salonId], references: [id])
  salonId   String   @db.ObjectId
  createdAt DateTime @default(now())

  @@unique([userId, salonId]) // Prevents double-favoriting
}

// ==========================================
// ENUMS
// ==========================================

enum SubscriptionType {
  SALON_BASIC
  SALON_PRO
  USER_VIP
}

enum SubscriptionStatus {
  active
  canceled
  expired
  past_due
}

enum AppRole {
  super_admin
  salon_admin
  salon_staff
  user
}

enum SalonStatus {
  pending
  approved
  rejected
  suspended
}

enum SalonRole {
  salon_admin
  salon_staff
}

enum BookingStatus {
  booked
  completed
  cancelled
  no_show
  in_progress
}

enum PaymentStatus {
  pending
  verified
  rejected
}

enum Gender {
  male
  female
  other
}
